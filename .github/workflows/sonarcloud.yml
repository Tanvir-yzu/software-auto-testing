# Workflow Name: SonarCloud Scan
name: SonarCloud Scan

# Trigger Events: কখন Workflow চালু হবে
on:
  push:
    branches: [ "main" ]           # main branch-এ push হলে চালু হবে
  pull_request:
    types: [opened, synchronize, reopened]  # PR open/update/reopen হলে চালু হবে

# Jobs Section: কোন কাজ চালানো হবে
jobs:
  sonarcloud:
    name: SonarCloud Analysis     # Job Name
    runs-on: ubuntu-latest        # Ubuntu Runner ব্যবহার করবে

    steps:
      # Step 1: কোড ক্লোন করুন (Checkout)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # পুরো Git History নিন (Blame Info এর জন্য)

      # Step 2: Python Setup (যদি Python প্রজেক্ট হয়)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # আপনার প্রজেক্টের Python Version

      # Step 3: Dependencies Install (requirements.txt থাকলে)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"

      # Step 4: Tests Run করুন এবং Coverage Report তৈরি করুন
      - name: Run tests with coverage
        run: |
          pip install pytest pytest-cov
          pytest --cov=. --cov-report=xml || echo "No tests found or failed"

      # Step 5: SonarCloud Scan চালান
      - name: SonarCloud Scan
        uses: sonarSource/sonarqube-scan-action@master
        env:
          # GitHub Token (Auto-provided by GitHub)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # SonarCloud Token (আপনি Secret-এ রেখেছেন)
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}